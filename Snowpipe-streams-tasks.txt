-- SnowPipe for Data ingestion from S3
CREATE OR REPLACE PIPE CUSTOMER_INGESTION_PIPE
AUTO_INGEST = TRUE
AS 
COPY INTO SCD_DB.PROJECT_DB.CUSTOMER_RAW
FROM @SCD_DB.PUBLIC.S3_EXTERNAL_STAGE/transformed_data/
-- PATTERN = 'transformed_data/customer.*/.*'
;

-- Streams
CREATE OR REPLACE STREAM raw_customer_stream ON TABLE SCD_DB.PROJECT_DB.CUSTOMER_RAW;
CREATE OR REPLACE STREAM dim_customer_stream ON TABLE SCD_DB.PROJECT_DB.DIM_CUSTOMER;


-- Tasks
-- Task to load data into SCD1
CREATE OR REPLACE TASK SCD1_LOAD
    WAREHOUSE = 'SYSADMIN_WAREHOUSE'
WHEN SYSTEM$STREAM_HAS_DATA('SCD_DB.PROJECT_DB.RAW_CUSTOMER_STREAM')
AS 
    CALL SCD_DB.PROJECT_DB.PROCESS_RAW_CUSTOMER_STREAM()
;

-- Task to load data into SCD2
CREATE OR REPLACE TASK SCD2_LOAD 
    WAREHOUSE = 'SYSADMIN_WAREHOUSE'
WHEN SYSTEM$STREAM_HAS_DATA('SCD_DB.PROJECT_DB.DIM_CUSTOMER_STREAM')
AS 
    CALL SCD_DB.PROJECT_DB.PROCESS_DIM_CUSTOMER_STREAM()
;